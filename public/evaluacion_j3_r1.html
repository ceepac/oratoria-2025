<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Evaluaci√≥n Jurado 3 - Ronda 1</title>
  <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="css/estilos.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <header>
    <img src="img/CEEPAC.png" alt="Logo CEEPAC" class="logo">
    <img src="img/Recurso 1.png" alt="Logo Concurso" class="logo">
  </header>

  <main class="container">
    <h1>Evaluaci√≥n - Jurado 3</h1>
    <h2>Mtro. Mariano Agust√≠n Olgu√≠n Huerta</h2>
    <h2>Ronda 1</h2>

    <form id="form-evaluacion">
      <div class="form-group">
        <label for="participante">Concursante:</label>
        <select id="participante" required></select>
      </div>

      <div class="form-group">
        <label for="tema">Tema:</label>
        <select id="tema" required></select>
      </div>

      <div class="card-datos">
        <h3>Datos de Participante</h3>
        <div class="info-linea"><strong>Nombre:</strong> <span id="info-nombre">-</span></div>
        <div class="info-linea"><strong>Edad:</strong> <span id="info-edad">-</span></div>
        <div class="info-linea"><strong>Nivel de estudios:</strong> <span id="info-nivel">-</span></div>
        <div class="info-linea"><strong>Experiencia en oratoria:</strong> <span id="info-experiencia">-</span></div>
        <div class="info-linea"><strong>Tema:</strong> <span id="info-tema">-</span></div>
        <div class="info-linea"><strong>Categor√≠a del tema:</strong> <span id="info-categoria">-</span></div>
      </div>

      <h3>Evaluaci√≥n por criterio</h3>

      <div class="form-group"><label>1. Presentaci√≥n:</label><select class="criterio" name="presentacion" required><option value="">Seleccione</option><option value="1">Malo - 1</option><option value="2">Deficiente - 2</option><option value="3">Regular - 3</option><option value="4">Bueno - 4</option><option value="5">Excelente - 5</option></select></div>
      <div class="form-group"><label>2. Dominio del tema:</label><select class="criterio" name="dominio_tema" required><option value="">Seleccione</option><option value="1">Malo - 1</option><option value="2">Deficiente - 2</option><option value="3">Regular - 3</option><option value="4">Bueno - 4</option><option value="5">Excelente - 5</option></select></div>
      <div class="form-group"><label>3. Dominio del auditorio:</label><select class="criterio" name="dominio_auditorio" required><option value="">Seleccione</option><option value="1">Malo - 1</option><option value="2">Deficiente - 2</option><option value="3">Regular - 3</option><option value="4">Bueno - 4</option><option value="5">Excelente - 5</option></select></div>
      <div class="form-group"><label>4. Dicci√≥n:</label><select class="criterio" name="diccion" required><option value="">Seleccione</option><option value="1">Malo - 1</option><option value="2">Deficiente - 2</option><option value="3">Regular - 3</option><option value="4">Bueno - 4</option><option value="5">Excelente - 5</option></select></div>
      <div class="form-group"><label>5. Claridad del mensaje:</label><select class="criterio" name="claridad_mensaje" required><option value="">Seleccione</option><option value="1">Malo - 1</option><option value="2">Deficiente - 2</option><option value="3">Regular - 3</option><option value="4">Bueno - 4</option><option value="5">Excelente - 5</option></select></div>
      <div class="form-group"><label>6. Conclusi√≥n:</label><select class="criterio" name="conclusion" required><option value="">Seleccione</option><option value="1">Malo - 1</option><option value="2">Deficiente - 2</option><option value="3">Regular - 3</option><option value="4">Bueno - 4</option><option value="5">Excelente - 5</option></select></div>

      <div class="form-group">
        <label for="comentarios">¬øDesea agregar alg√∫n comentario?</label><br/>
        <textarea id="comentarios" rows="4" cols="50" placeholder="Escribe aqu√≠..."></textarea>
      </div>

      <div class="form-group">
        <p><strong>Total:</strong> <span id="total">0</span> puntos</p>
      </div>

      <button type="submit" class="boton-principal">Guardar y continuar</button>
      <div class="contenedor-volver"><a href="/menu_jurado3.html" class="boton-volver">Volver</a></div>
    </form>
  </main>

  <footer>
    <p>¬© 2025 CEEPAC. MSK // Todos los derechos reservados.</p>
  </footer>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://idvgzyyvgdbiwzgndxtk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlkdmd6eXl2Z2RiaXd6Z25keHRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMTc0MjIsImV4cCI6MjA2OTg5MzQyMn0.a8YA2MYTG0KVxu5qLe8pmia3s0lzod-R19W81VSsb7o'
    );

   async function cargarTemas() {
  const participante = document.getElementById('participante').value;

  if (!participante) {
    document.getElementById('tema').innerHTML = '<option value="">Selecciona un tema</option>';
    return;
  }

  // 1. Obtener todos los temas disponibles
  const { data: todosTemas, error: errorTemas } = await supabase.from('temas').select('titulo').order('titulo');

  // 2. Obtener temas ya usados por el participante (en cualquier ronda)
  // ‚úÖ Solo bloquear temas usados por el participante ACTUAL
    const { data: usados, error: errorUsados } = await supabase
    .from('evaluacion_j3_r1')
    .select('tema')
    .eq('participante', participante);

    const temasUsados = usados ? usados.map(t => t.tema) : [];


  // 3. Filtrar y poblar el selector
  const select = document.getElementById('tema');
  select.innerHTML = '<option value="">Selecciona un tema</option>';

  if (todosTemas) {
    todosTemas.forEach(t => {
      if (!temasUsados.includes(t.titulo)) {
        const opt = document.createElement('option');
        opt.value = t.titulo;
        opt.textContent = t.titulo;
        select.appendChild(opt);
      }
    });
  }
}

async function cargarParticipantes() {
  const { data, error } = await supabase
    .from('participantes')
    .select('nombre_completo')
    .order('nombre_completo', { ascending: true });

  const { data: evaluados, error: errorEv } = await supabase
    .from('evaluacion_j3_r1')
    .select('participante');

  const participantesEvaluados = evaluados ? evaluados.map(p => p.participante) : [];

  const select = document.getElementById('participante');
  select.innerHTML = '<option value="">Selecciona un participante</option>';

  if (data) {
    data.forEach(p => {
      if (!participantesEvaluados.includes(p.nombre_completo)) {
        const opt = document.createElement('option');
        opt.value = p.nombre_completo;
        opt.textContent = p.nombre_completo;
        select.appendChild(opt);
      }
    });
  }
}



    cargarParticipantes();
    
    const criterios = document.querySelectorAll('.criterio');
    const totalSpan = document.getElementById('total');
    criterios.forEach(sel => {
      sel.addEventListener('change', () => {
        let total = 0;
        criterios.forEach(c => total += parseInt(c.value) || 0);
        totalSpan.textContent = total;
      });
    });

    document.getElementById('form-evaluacion').addEventListener('submit', async (e) => {
      e.preventDefault();

      const tabla = "evaluacion_j3_r1";

      const evaluacion = {
        jurado: "j3",
        ronda: "1",
        participante: document.getElementById('participante').value,
        tema: document.getElementById('tema').value,
        presentacion: parseInt(document.querySelector('[name="presentacion"]').value),
        dominio_tema: parseInt(document.querySelector('[name="dominio_tema"]').value),
        dominio_auditorio: parseInt(document.querySelector('[name="dominio_auditorio"]').value),
        diccion: parseInt(document.querySelector('[name="diccion"]').value),
        claridad_mensaje: parseInt(document.querySelector('[name="claridad_mensaje"]').value),
        conclusion: parseInt(document.querySelector('[name="conclusion"]').value),
        comentarios: document.getElementById('comentarios').value,
        creada_en: new Date().toISOString()
      };

      const response = await fetch('/api/evaluacion', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tabla, ...evaluacion })
      });

      if (response.ok) {
  alert('‚úÖ Evaluaci√≥n guardada correctamente');

  // Reset del formulario
  document.getElementById('form-evaluacion').reset();
  totalSpan.textContent = "0";

  // Limpiar campos informativos
  document.getElementById('info-nombre').textContent = '-';
  document.getElementById('info-edad').textContent = '-';
  document.getElementById('info-nivel').textContent = '-';
  document.getElementById('info-experiencia').textContent = '-';
  document.getElementById('info-tema').textContent = '-';
  document.getElementById('info-categoria').textContent = '-';

  // Limpiar temas
  document.getElementById('tema').innerHTML = '<option value="">Selecciona un tema</option>';

  // üî• Quitar participante evaluado directamente del DOM
  const selectParticipante = document.getElementById('participante');
  const optionToRemove = selectParticipante.querySelector(`option[value="${evaluacion.participante}"]`);
  if (optionToRemove) optionToRemove.remove();

   // üîÑ Volver al principio de la p√°gina
  window.scrollTo({ top: 0, behavior: 'smooth' });

  // Recargar participantes (por si hay otros nuevos desde backend)
  await cargarParticipantes();
}  else 
      {
        alert('‚ùå Error al guardar la evaluaci√≥n');
      }
    });

    document.getElementById('participante').addEventListener('change', async (e) => {
  const nombre = e.target.value;
  if (!nombre) return;
  document.getElementById('info-nombre').textContent = nombre;

  const { data } = await supabase.from('participantes').select('edad, nivel_estudios, experiencia_oratoria').eq('nombre_completo', nombre).single();
  if (data) {
    document.getElementById('info-edad').textContent = data.edad || '-';
    document.getElementById('info-nivel').textContent = data.nivel_estudios || '-';
    document.getElementById('info-experiencia').textContent = data.experiencia_oratoria || '-';
  }

  // üî• Aqu√≠ se llama a la funci√≥n para cargar los temas disponibles
  await cargarTemas();
});


    document.getElementById('tema').addEventListener('change', async (e) => {
      const titulo = e.target.value;
      if (!titulo) return;
      document.getElementById('info-tema').textContent = titulo;

      const { data } = await supabase.from('temas').select('categoria').eq('titulo', titulo).single();
      if (data) {
        document.getElementById('info-categoria').textContent = data.categoria || '-';
      }
    });
  </script>
</body>
</html>
